# Редактирование заказов и история изменений

## Обзор

Система теперь поддерживает полное редактирование заказов и ведение полной истории всех изменений с датой и временем.

## Функциональность

### 1. Редактирование заказов (для ресторана)

На странице деталей заказа ресторан может:
- **Изменить количество товара** - нажать +/- для увеличения/уменьшения количества
- **Удалить товар** - нажать кнопку "Удалить" рядом с товаром
- Все изменения автоматически логируются в историю

### 2. История заказа

Каждое действие с заказом записывается в таблицу `orderHistory`:

#### Типы действий:
- `created` - Заказ создан
- `item_removed` - Товар удалён
- `item_quantity_changed` - Количество товара изменено
- `status_changed` - Статус заказа изменён
- `item_added` - Товар добавлен (зарезервировано для будущего)
- `address_changed` - Адрес доставки изменён (зарезервировано для будущего)

#### Информация в истории:
- **Действие** - тип изменения
- **Кто сделал** - имя пользователя, который сделал изменение
- **Дата и время** - точное время действия (год, месяц, день, часы, минуты)
- **Детали** - специфичные для каждого действия:
  - Для `status_changed`: старый статус → новый статус
  - Для `item_removed`: название товара и количество
  - Для `item_quantity_changed`: название товара, старое количество → новое количество
  - Для `created`: количество товаров и общая сумма

### 3. Дата и время создания заказа

На странице деталей заказа отображается:
- **Дата и время создания** - в формате "день месяца год, часы:минуты"
- Пример: "8 января 2026, 14:30"

## Структура базы данных

### Таблица `orderHistory`

```typescript
{
  orderId: Id<"orders">,           // ID заказа
  action: string,                   // Тип действия
  details: {
    oldValue?: any,                 // Старое значение
    newValue?: any,                 // Новое значение
    productId?: Id<"products">,     // ID товара
    productName?: string,           // Название товара
  },
  changedBy: Id<"users">,          // Кто сделал изменение
  createdAt: number,               // Время действия (timestamp)
}
```

## API функции

### Запросы (Queries)

#### `getOrderHistory(orderId)`
Получить полную историю заказа с информацией о пользователях.

```typescript
const history = await api.orders.getOrderHistory({ orderId });
```

### Мутации (Mutations)

#### `removeOrderItem(orderId, productId, userId)`
Удалить товар из заказа и залогировать действие.

```typescript
await removeOrderItem({
  orderId: order._id,
  productId: item.productId,
  userId: user._id,
});
```

#### `updateOrderItemQuantity(orderId, productId, quantity, userId)`
Изменить количество товара в заказе и залогировать действие.

```typescript
await updateOrderItemQuantity({
  orderId: order._id,
  productId: item.productId,
  quantity: newQuantity,
  userId: user._id,
});
```

#### `updateStatus(orderId, status, userId)`
Изменить статус заказа и залогировать действие.

```typescript
await updateStatus({
  orderId: order._id,
  status: newStatus,
  userId: user._id,
});
```

## Интерфейс пользователя

### Страница деталей заказа ресторана
- Кнопка "История" для показа/скрытия истории
- Кнопки +/- для изменения количества товара
- Кнопка "Удалить" для удаления товара
- Полная история с датой и временем каждого действия

### Страница деталей заказа поставщика
- Кнопка "История" для показа/скрытия истории
- Полная история с датой и временем каждого действия
- Возможность изменения статуса заказа (с логированием)

## Примеры использования

### Удаление товара
1. Ресторан открывает заказ
2. Нажимает "Удалить" рядом с товаром
3. Товар удаляется, сумма пересчитывается
4. В истории появляется запись: "Товар удалён - Помидоры (5 кг)"

### Изменение количества
1. Ресторан нажимает + или - рядом с товаром
2. Количество изменяется, сумма пересчитывается
3. В истории появляется запись: "Количество изменено - Помидоры: 5 кг → 3 кг"

### Изменение статуса
1. Поставщик открывает заказ
2. Выбирает новый статус из выпадающего списка
3. Статус изменяется
4. В истории появляется запись: "Статус изменён - Ожидание → Подтверждено"

## Безопасность

- Все изменения логируются с указанием пользователя, который их сделал
- История неизменяема - новые записи только добавляются, не удаляются
- Каждое действие имеет точное время выполнения
- Ничего не остаётся без следа
